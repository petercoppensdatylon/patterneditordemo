<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Palette Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between flex-wrap gap-3">
      <h1 class="text-2xl font-bold">Palette Builder</h1>
      <div class="flex items-center gap-2">
        <button id="exportBtn" type="button" class="px-4 py-2 rounded-2xl border hover:bg-slate-50">Export JSON</button>
        <input id="importInput" type="file" accept="application/json,.json" class="hidden" />
        <button id="importBtn" type="button" class="px-4 py-2 rounded-2xl border hover:bg-slate-50">Import JSON</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Sidebar -->
      <aside class="space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Your palettes</h2>
          <button id="newPaletteBtn" type="button"
                  class="inline-flex items-center justify-center p-2 rounded-xl border bg-white shadow-sm hover:shadow transition"
                  title="New palette">
            <i data-lucide="plus" class="w-4 h-4"></i>
          </button>
        </div>
        <div id="paletteList" class="space-y-2"></div>
        <div id="noPalettes" class="rounded-2xl border border-dashed text-slate-600 text-sm text-center py-8 px-4 bg-white/60">
          <div class="mb-3">No palettes yet.</div>
          <button id="createFirstBtn" type="button"
                  class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>New palette</span>
          </button>
          <div class="mt-3 text-xs text-slate-500">or Import JSON</div>
        </div>
      </aside>

      <!-- Editor -->
      <section class="md:col-span-2">
        <div id="editorSection" class="hidden rounded-3xl bg-white shadow p-6 space-y-5">
          <div class="flex items-center justify-between">
            <input id="paletteName" type="text" class="flex-1 rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Palette name (autosaves)" />
            <button id="deletePalette" type="button" class="ml-3 px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Delete palette</button>
          </div>

          <!-- Add / Edit Item with compact controls + Live Preview -->
          <div class="grid md:grid-cols-3 gap-6">
            <div class="md:col-span-2 rounded-2xl border p-4 space-y-4">
              <h3 class="font-semibold">Add / Edit Item</h3>

              <!-- Type + Angle (compact) -->
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-center">
                <div>
                  <label class="text-xs font-medium">Type</label>
                  <select id="itemType" class="w-full rounded-xl border px-2 py-2">
                    <option value="rgb">Solid RGB</option>
                    <option value="pattern">Pattern</option>
                  </select>
                </div>
                <div id="angleWrap" class="sm:col-span-2 hidden">
                  <label class="text-xs font-medium">Angle</label>
                  <div class="flex items-center gap-2">
                    <input id="angleRange" type="range" min="-180" max="180" value="45" class="flex-1" />
                    <input id="angleNum" type="number" min="-180" max="180" value="45" class="w-20 rounded border px-2 py-1" />
                  </div>
                </div>
              </div>

              <!-- Foreground row -->
              <div id="fgRow" class="hidden grid grid-cols-3 md:grid-cols-6 gap-3 items-end">
                <div class="col-span-2">
                  <label class="text-xs font-medium">FG Color</label>
                  <input id="patternFgColor" type="color" value="#111827" class="w-full h-9 border rounded" />
                </div>
                <div>
                  <label class="text-xs font-medium">FG Width</label>
                  <input id="patternFgWidth" type="number" step="0.5" min="0.5" value="6" class="w-full rounded border px-2 py-1" />
                </div>
                <div class="col-span-2">
                  <label class="text-xs font-medium">FG Opacity</label>
                  <div class="flex items-center gap-2">
                    <input id="fgOpacityRange" type="range" min="0" max="100" value="100" class="flex-1" />
                    <input id="patternFgOpacity" type="number" min="0" max="100" value="100" class="w-16 rounded border px-2 py-1" />
                  </div>
                </div>
              </div>

              <!-- Background row -->
              <div id="bgRow" class="hidden grid grid-cols-3 md:grid-cols-6 gap-3 items-end">
                <div class="col-span-2">
                  <label class="text-xs font-medium">BG Color</label>
                  <input id="patternBgColor" type="color" value="#e5e7eb" class="w-full h-9 border rounded" />
                </div>
                <div>
                  <label class="text-xs font-medium">BG Width</label>
                  <input id="patternBgWidth" type="number" step="0.5" min="0.5" value="6" class="w-full rounded border px-2 py-1" />
                </div>
                <div class="col-span-2">
                  <label class="text-xs font-medium">BG Opacity</label>
                  <div class="flex items-center gap-2">
                    <input id="bgOpacityRange" type="range" min="0" max="100" value="100" class="flex-1" />
                    <input id="patternBgOpacity" type="number" min="0" max="100" value="100" class="w-16 rounded border px-2 py-1" />
                  </div>
                </div>
              </div>

              <!-- Solid controls compact -->
              <div id="solidRow" class="grid grid-cols-3 md:grid-cols-6 gap-3 items-end">
                <div class="col-span-2">
                  <label class="text-xs font-medium">Color</label>
                  <input id="solidColor" type="color" value="#4f46e5" class="w-full h-9 border rounded" />
                </div>
                <div class="col-span-3 md:col-span-4">
                  <label class="text-xs font-medium">Opacity</label>
                  <div class="flex items-center gap-2">
                    <input id="solidOpacity" type="range" min="0" max="100" value="100" class="flex-1" />
                    <input id="solidOpacityNum" type="number" min="0" max="100" value="100" class="w-16 rounded border px-2 py-1" />
                  </div>
                </div>
              </div>

              <div class="flex justify-end gap-3">
                <button id="resetItem" type="button" class="px-3 py-2 rounded-xl border hover:bg-slate-50">Reset</button>
                <button id="saveItem" type="button" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Add item</button>
              </div>
            </div>

            <!-- Compact Live Item Preview (no title) -->
            <div class="rounded-2xl border p-3 flex items-center justify-center">
              <div id="itemPreview" class="w-16 h-16 rounded-xl border shadow-inner"></div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Helpers =====
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    const STORE_KEY = 'palettes-v1';
    const uid = () => 'id_' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36).slice(-4);
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const load = () => { try { return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); } catch { return []; } };
    const save = (data) => localStorage.setItem(STORE_KEY, JSON.stringify(data));

    const debounce = (fn, ms=400) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); } };

    function rgba(hex, op100=100){
      const v = (hex||'#000000').replace('#','');
      const n = v.length===3 ? v.split('').map(x=>parseInt(x+x,16)) : [parseInt(v.slice(0,2),16), parseInt(v.slice(2,4),16), parseInt(v.slice(4,6),16)];
      return `rgba(${n[0]}, ${n[1]}, ${n[2]}, ${clamp(+op100/100,0,1)})`;
    }

    function patternDef(p){
      const fgO = clamp((+p.fgOpacity||0)/100,0,1);
      const bgO = clamp((+p.bgOpacity||0)/100,0,1);
      const angle = +p.angle||0;
      const fgW = Math.max(0.5, +p.fgWidth||0.5);
      const bgW = Math.max(0.5, +p.bgWidth||0.5);
      const total = fgW + bgW;
      const id = p.id || 'pat_'+uid();
      return `<pattern id="${id}" patternUnits="userSpaceOnUse" width="${total}" height="${total}" patternTransform="rotate(${angle})">
        <rect width="${total}" height="${total}" fill="transparent"/>
        <rect width="${fgW}" height="${total}" fill="${p.fgColor}" fill-opacity="${fgO}"/>
        <rect x="${fgW}" width="${bgW}" height="${total}" fill="${p.bgColor}" fill-opacity="${bgO}"/>
      </pattern>`;
    }

    function buildPatternSVG(p){
      const id = p.id || ('pat_'+uid());
      const def = patternDef({ ...p, id });
      return (`<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80" viewBox="0 0 120 80">
  <defs>
    ${def}
  </defs>
  <rect x="0" y="0" width="120" height="80" fill="url(#${id})" />
</svg>`).trim();
    }

    function patternPreview(p, size=28){
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
      svg.setAttribute('width', size);
      svg.setAttribute('height', size);
      const defs = document.createElementNS(svg.namespaceURI,'defs');
      const id = 'pat_'+(p.id || uid());
      defs.innerHTML = patternDef({...p, id});
      svg.appendChild(defs);
      const rect = document.createElementNS(svg.namespaceURI,'rect');
      rect.setAttribute('x','0');rect.setAttribute('y','0');rect.setAttribute('width',size);rect.setAttribute('height',size);
      rect.setAttribute('rx','8');
      rect.setAttribute('fill', `url(#${id})`);
      svg.appendChild(rect);
      return svg;
    }

    // ===== State =====
    let palettes = load();
    let currentId = palettes[0]?.id || null;

    // ===== Elements =====
    const paletteList = $('#paletteList');
    const noPalettes = $('#noPalettes');
    const newPaletteBtn = $('#newPaletteBtn');

    const editorSection = $('#editorSection');
    const paletteName = $('#paletteName');
    const deletePalette = $('#deletePalette');

    // Item editor controls
    const itemType = $('#itemType');
    const angleWrap = $('#angleWrap');
    const angleRange = $('#angleRange');
    const angleNum = $('#angleNum');

    const solidRow = $('#solidRow');
    const solidColor = $('#solidColor');
    const solidOpacity = $('#solidOpacity');
    const solidOpacityNum = $('#solidOpacityNum');

    const fgRow = $('#fgRow');
    const patternFgWidth = $('#patternFgWidth');
    const patternFgColor = $('#patternFgColor');
    const fgOpacityRange = $('#fgOpacityRange');
    const patternFgOpacity = $('#patternFgOpacity');

    const bgRow = $('#bgRow');
    const patternBgWidth = $('#patternBgWidth');
    const patternBgColor = $('#patternBgColor');
    const bgOpacityRange = $('#bgOpacityRange');
    const patternBgOpacity = $('#patternBgOpacity');

    const itemPreview = $('#itemPreview');
    const resetItem = $('#resetItem');
    const saveItem = $('#saveItem');
    let editingItemId = '';

    // ===== Renderers =====
    function renderSidebar(){
      paletteList.innerHTML='';
      if(!palettes.length){ noPalettes.classList.remove('hidden'); editorSection.classList.add('hidden'); return; }
      noPalettes.classList.add('hidden');

      palettes.forEach(pal=>{
        const wrap = document.createElement('div');
        wrap.className = `rounded-2xl border p-3 ${pal.id===currentId?'ring-2 ring-indigo-500':''}`;

        const headerBtn = document.createElement('button');
        headerBtn.type='button';
        headerBtn.className='w-full text-left flex items-center justify-between gap-3 hover:bg-slate-50 rounded-xl px-2 py-2';
        headerBtn.innerHTML = `<div><div class=\"font-medium truncate\">${pal.name||'Untitled palette'}</div><div class=\"text-xs text-slate-500\">${pal.items?.length||0} item(s)</div></div>`;
        headerBtn.addEventListener('click',()=>{ currentId = pal.id; renderSidebar(); openEditor(); });
        wrap.appendChild(headerBtn);

        // Row with delete button (left) + grid (right) — always visible
        const row = document.createElement('div');
        row.className = 'mt-2 flex items-start gap-2';
        const delBtn = document.createElement('button');
        delBtn.type='button';
        delBtn.className='p-2 rounded-lg hover:bg-rose-100 text-rose-600';
        delBtn.innerHTML = '<i data-lucide="trash" class="w-4 h-4"></i>';
        delBtn.title = 'Delete palette';
        delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(confirm(`Delete palette \"${pal.name}\"?`)){ palettes = palettes.filter(p=>p.id!==pal.id); save(palettes); currentId = palettes[0]?.id||null; renderSidebar(); openEditor(); }});

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-6 gap-3 flex-1';
        (pal.items||[]).forEach(it=>{
          const cell = document.createElement('div');
          cell.className='flex flex-col items-center gap-0.5';
          const swatch = document.createElement('div');
          swatch.className='w-8 h-8 rounded-lg border border-slate-200 overflow-hidden';
          if((it.type||'rgb')==='rgb'){ swatch.style.background = rgba(it.color||'#000', it.opacity ?? 100); }
          else { swatch.appendChild(patternPreview(it, 32)); }
          const actions = document.createElement('div');
          actions.className='flex items-center gap-0.5 -mt-0.5';
          const editBtn = document.createElement('button'); editBtn.type='button'; editBtn.className='p-0.5 rounded hover:bg-slate-100'; editBtn.innerHTML='<i data-lucide="pen" class="w-3 h-3"></i>';
          const delItemBtn = document.createElement('button'); delItemBtn.type='button'; delItemBtn.className='p-0.5 rounded hover:bg-rose-100 text-rose-600'; delItemBtn.innerHTML='<i data-lucide="trash" class="w-3 h-3"></i>';
          editBtn.addEventListener('click', (e)=>{ e.stopPropagation(); currentId = pal.id; openEditor(); loadItemIntoForm(it.id); });
          delItemBtn.addEventListener('click', (e)=>{ e.stopPropagation(); removeItem(it.id); });
          actions.append(editBtn, delItemBtn);
          cell.append(swatch, actions); grid.appendChild(cell);
        });
        row.append(delBtn, grid);
        wrap.appendChild(row);

        paletteList.appendChild(wrap);
      });

      lucide.createIcons();
    }

    function currentPalette(){ return palettes.find(p=>p.id===currentId); }

    function openEditor(){
      const pal = currentPalette(); if(!pal){ editorSection.classList.add('hidden'); return; }
      editorSection.classList.remove('hidden');
      paletteName.value = pal.name||'';
    }

    // ===== Palette actions =====
    newPaletteBtn.addEventListener('click', ()=>{
      const pal = { id: uid(), name: 'New palette', items: [] };
      palettes.unshift(pal); currentId = pal.id; save(palettes);
      renderSidebar(); openEditor();
    });

    // Auto-save palette name (debounced)
    const saveNameDebounced = debounce(()=>{
      const pal = currentPalette(); if(!pal) return;
      pal.name = paletteName.value.trim() || 'Untitled palette';
      save(palettes); renderSidebar();
    }, 400);
    paletteName.addEventListener('input', saveNameDebounced);

    deletePalette.addEventListener('click', ()=>{
      const pal = currentPalette(); if(!pal) return;
      if(!confirm(`Delete palette "${pal.name}"?`)) return;
      palettes = palettes.filter(p=>p.id!==pal.id); save(palettes);
      currentId = palettes[0]?.id || null; renderSidebar(); openEditor();
    });

    // ===== Item editor =====
    function switchTypeUI(){
      const t = itemType.value;
      const isPattern = t==='pattern';
      angleWrap.classList.toggle('hidden', !isPattern);
      fgRow.classList.toggle('hidden', !isPattern);
      bgRow.classList.toggle('hidden', !isPattern);
      solidRow.classList.toggle('hidden', isPattern);
      renderItemPreview();
    }
    itemType.addEventListener('change', switchTypeUI);

    function resetForm(){
      editingItemId='';
      saveItem.textContent = 'Add item';
      itemType.value='rgb';
      angleRange.value=45; angleNum.value=45;
      solidColor.value='#4f46e5'; solidOpacity.value=100; solidOpacityNum.value=100;
      patternFgWidth.value=6; patternFgColor.value='#111827'; fgOpacityRange.value=100; patternFgOpacity.value=100;
      patternBgWidth.value=6; patternBgColor.value='#e5e7eb'; bgOpacityRange.value=100; patternBgOpacity.value=100;
      switchTypeUI();
    }
    resetItem.addEventListener('click', resetForm);

    function readItem(){
      const t = itemType.value;
      if(t==='rgb'){
        return { id: editingItemId || uid(), type:'rgb', color: solidColor.value, opacity: clamp(+solidOpacity.value||0,0,100) };
      } else {
        return { id: editingItemId || uid(), type:'pattern', angle:+angleNum.value||0, fgWidth:+patternFgWidth.value||6, fgColor:patternFgColor.value, fgOpacity:clamp(+patternFgOpacity.value||0,0,100), bgWidth:+patternBgWidth.value||6, bgColor:patternBgColor.value, bgOpacity:clamp(+patternBgOpacity.value||0,0,100) };
      }
    }

    function loadItemIntoForm(id){
      const pal = currentPalette(); if(!pal) return;
      const it = pal.items.find(x=>x.id===id); if(!it) return;
      editingItemId = it.id; saveItem.textContent='Save changes';
      const t = it.type; itemType.value = t; switchTypeUI();
      if(t==='rgb'){ solidColor.value = it.color||'#000000'; solidOpacity.value = it.opacity ?? 100; solidOpacityNum.value = it.opacity ?? 100; }
      else { angleRange.value = it.angle ?? 45; angleNum.value = it.angle ?? 45; patternFgWidth.value=it.fgWidth??6; patternFgColor.value=it.fgColor||'#111827'; fgOpacityRange.value=it.fgOpacity??100; patternFgOpacity.value=it.fgOpacity??100; patternBgWidth.value=it.bgWidth??6; patternBgColor.value=it.bgColor||'#e5e7eb'; bgOpacityRange.value=it.bgOpacity??100; patternBgOpacity.value=it.bgOpacity??100; }
      renderItemPreview();
    }

    function removeItem(id){
      const pal = currentPalette(); if(!pal) return;
      pal.items = pal.items.filter(x=>x.id!==id); save(palettes); renderSidebar();
      if(editingItemId===id) resetForm();
    }

    saveItem.addEventListener('click', ()=>{
      const pal = currentPalette(); if(!pal) return;
      const it = readItem();
      const i = pal.items.findIndex(x=>x.id===it.id);
      if(i===-1) pal.items.push(it); else pal.items[i]=it;
      save(palettes); renderSidebar(); resetForm();
    });

    // live preview of item being edited
    function renderItemPreview(){
      itemPreview.innerHTML='';
      const it = readItem();
      if(it.type==='rgb'){
        itemPreview.style.background = rgba(it.color, it.opacity);
      } else {
        itemPreview.style.background = '';
        itemPreview.appendChild(patternPreview(it, 64));
      }
    }

    // link range + number pairs and repaint
    function linkRangeNumber(rangeEl, numEl, min=-180, max=180){
      const clampN = v => Math.min(max, Math.max(min, v));
      rangeEl.addEventListener('input', ()=>{ numEl.value = rangeEl.value; renderItemPreview(); });
      numEl.addEventListener('input', ()=>{ const v = clampN(+numEl.value||0); numEl.value = v; rangeEl.value = v; renderItemPreview(); });
    }
    linkRangeNumber(angleRange, angleNum, -180, 180);

    function linkOpacity(rangeEl, numEl){
      rangeEl.addEventListener('input', ()=>{ numEl.value = rangeEl.value; renderItemPreview(); });
      numEl.addEventListener('input', ()=>{ const v = clamp(+numEl.value||0,0,100); numEl.value=v; rangeEl.value=v; renderItemPreview(); });
    }
    linkOpacity(solidOpacity, solidOpacityNum);
    linkOpacity(fgOpacityRange, patternFgOpacity);
    linkOpacity(bgOpacityRange, patternBgOpacity);

    // continuous preview on input
    [solidColor, patternFgWidth, patternFgColor, patternBgWidth, patternBgColor].forEach(el=> el.addEventListener('input', renderItemPreview));

    // ===== Import/Export =====
    function exportPalettes(){
      const enriched = palettes.map(pal => ({
        ...pal,
        items: (pal.items||[]).map(it => it.type==='pattern' ? ({...it, svg: buildPatternSVG(it)}) : it)
      }));
      const blob = new Blob([JSON.stringify(enriched, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`palettes-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    $('#exportBtn').addEventListener('click', exportPalettes);
    $('#importBtn').addEventListener('click', ()=> $('#importInput').click());
    $('#importInput').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{
        const text = await f.text(); const payload = JSON.parse(text);
        const list = Array.isArray(payload) ? payload : (Array.isArray(payload.palettes)? payload.palettes : []);
        if(!list.length){ alert('No palettes found in JSON. Expect an array or {"palettes": [...]}'); return; }
        let added=0; list.forEach(raw=>{ const pal={ id: typeof raw.id==='string'&&raw.id || uid(), name: typeof raw.name==='string'? raw.name:'Imported', items: Array.isArray(raw.items)? raw.items : []}; if(palettes.some(x=>x.id===pal.id)) pal.id=uid(); palettes.push(pal); added++; });
        save(palettes); if(!currentId) currentId=palettes[0].id; renderSidebar(); openEditor(); alert(`Imported ${added} palette${added===1?'':'s'}`);
      }catch(err){ console.error(err); alert('Invalid JSON file'); }
      finally{ e.target.value=''; }
    });

    // ===== Init =====
    // Ensure icons render immediately
    document.addEventListener('DOMContentLoaded', () => { try { lucide.createIcons(); } catch(e){} });

    renderSidebar(); if(currentId) openEditor(); resetForm(); renderItemPreview();

    // Hook the empty-state "New palette" button (exists only when empty)
    const firstBtn = document.getElementById('createFirstBtn');
    if (firstBtn) firstBtn.addEventListener('click', () => newPaletteBtn.click());
  </script>
</body>
</html>
